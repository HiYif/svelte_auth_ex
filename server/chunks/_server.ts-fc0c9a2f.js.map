{"version":3,"file":"_server.ts-fc0c9a2f.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/auth/_slug_/_server.ts.js"],"sourcesContent":["import { e as error, j as json } from \"../../../../chunks/index.js\";\nimport { q as query } from \"../../../../chunks/db.js\";\nconst POST = async (event) => {\n  const { slug } = event.params;\n  let result;\n  let sql;\n  try {\n    switch (slug) {\n      case \"logout\":\n        if (event.locals.user) {\n          sql = `CALL delete_session($1);`;\n          result = await query(sql, [event.locals.user.id]);\n        }\n        return json({ message: \"Logout successful.\" }, {\n          headers: {\n            \"Set-Cookie\": `session=; Path=/; SameSite=Lax; HttpOnly; Expires=${(/* @__PURE__ */ new Date()).toUTCString()}`\n          }\n        });\n      case \"login\":\n        sql = `SELECT authenticate($1) AS \"authenticationResult\";`;\n        break;\n      case \"register\":\n        sql = `SELECT register($1) AS \"authenticationResult\";`;\n        break;\n      default:\n        throw error(404, \"Invalid endpoint.\");\n    }\n    const body = await event.request.json();\n    if (slug == \"register\" && (!body.email || !body.password || !body.firstName || !body.lastName))\n      throw error(400, \"Please supply all required fields: email, password, first and last name.\");\n    result = await query(sql, [JSON.stringify(body)]);\n  } catch (err) {\n    throw error(503, \"Could not communicate with database.\");\n  }\n  const { authenticationResult } = result.rows[0];\n  if (!authenticationResult.user)\n    throw error(authenticationResult.statusCode, authenticationResult.status);\n  event.locals.user = authenticationResult.user;\n  return json(\n    {\n      message: authenticationResult.status,\n      user: authenticationResult.user\n    },\n    {\n      headers: {\n        \"Set-Cookie\": `session=${authenticationResult.sessionId}; Path=/; SameSite=Lax; HttpOnly;`\n      }\n    }\n  );\n};\nexport {\n  POST\n};\n"],"names":[],"mappings":";;;;AAEK,MAAC,IAAI,GAAG,OAAO,KAAK,KAAK;AAC9B,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,KAAK,CAAC,MAAM,CAAC;AAChC,EAAE,IAAI,MAAM,CAAC;AACb,EAAE,IAAI,GAAG,CAAC;AACV,EAAE,IAAI;AACN,IAAI,QAAQ,IAAI;AAChB,MAAM,KAAK,QAAQ;AACnB,QAAQ,IAAI,KAAK,CAAC,MAAM,CAAC,IAAI,EAAE;AAC/B,UAAU,GAAG,GAAG,CAAC,wBAAwB,CAAC,CAAC;AAC3C,UAAU,MAAM,GAAG,MAAM,KAAK,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC;AAC5D,SAAS;AACT,QAAQ,OAAO,IAAI,CAAC,EAAE,OAAO,EAAE,oBAAoB,EAAE,EAAE;AACvD,UAAU,OAAO,EAAE;AACnB,YAAY,YAAY,EAAE,CAAC,kDAAkD,EAAE,CAAgB,CAAC,IAAI,IAAI,EAAE,EAAE,WAAW,EAAE,CAAC,CAAC;AAC3H,WAAW;AACX,SAAS,CAAC,CAAC;AACX,MAAM,KAAK,OAAO;AAClB,QAAQ,GAAG,GAAG,CAAC,kDAAkD,CAAC,CAAC;AACnE,QAAQ,MAAM;AACd,MAAM,KAAK,UAAU;AACrB,QAAQ,GAAG,GAAG,CAAC,8CAA8C,CAAC,CAAC;AAC/D,QAAQ,MAAM;AACd,MAAM;AACN,QAAQ,MAAM,KAAK,CAAC,GAAG,EAAE,mBAAmB,CAAC,CAAC;AAC9C,KAAK;AACL,IAAI,MAAM,IAAI,GAAG,MAAM,KAAK,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;AAC5C,IAAI,IAAI,IAAI,IAAI,UAAU,KAAK,CAAC,IAAI,CAAC,KAAK,IAAI,CAAC,IAAI,CAAC,QAAQ,IAAI,CAAC,IAAI,CAAC,SAAS,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC;AAClG,MAAM,MAAM,KAAK,CAAC,GAAG,EAAE,0EAA0E,CAAC,CAAC;AACnG,IAAI,MAAM,GAAG,MAAM,KAAK,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AACtD,GAAG,CAAC,OAAO,GAAG,EAAE;AAChB,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,sCAAsC,CAAC,CAAC;AAC7D,GAAG;AACH,EAAE,MAAM,EAAE,oBAAoB,EAAE,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AAClD,EAAE,IAAI,CAAC,oBAAoB,CAAC,IAAI;AAChC,IAAI,MAAM,KAAK,CAAC,oBAAoB,CAAC,UAAU,EAAE,oBAAoB,CAAC,MAAM,CAAC,CAAC;AAC9E,EAAE,KAAK,CAAC,MAAM,CAAC,IAAI,GAAG,oBAAoB,CAAC,IAAI,CAAC;AAChD,EAAE,OAAO,IAAI;AACb,IAAI;AACJ,MAAM,OAAO,EAAE,oBAAoB,CAAC,MAAM;AAC1C,MAAM,IAAI,EAAE,oBAAoB,CAAC,IAAI;AACrC,KAAK;AACL,IAAI;AACJ,MAAM,OAAO,EAAE;AACf,QAAQ,YAAY,EAAE,CAAC,QAAQ,EAAE,oBAAoB,CAAC,SAAS,CAAC,iCAAiC,CAAC;AAClG,OAAO;AACP,KAAK;AACL,GAAG,CAAC;AACJ;;;;"}